<%- include('partials/header'); -%>

<script src="https://unpkg.com/vue@3.0.2"></script>

<%- include('components/DataTable.vue.ejs'); %>
<%- include('components/EditModal.vue.ejs'); %>

<h1>Benutzer</h1>

<div id="app">
  <div v-show="error" class="w3-panel w3-red">
    <p>{{ error }}</p>
  </div>

  <div class="w3-responsive">
    <form @submit.prevent="handleFilterSubmit">
      <label>Nur aktive&nbsp;</label>
      <input type="checkbox" v-model="filter.active" class="w3-check" />
      <p></p>
      <button class="w3-button w3-black" type="submit">Suchen</button>
      <p></p>
    </form>

    <p></p>

    <data-table
      :columns="userColumns"
      :rows="users"
      row-key="id"
      @cell-click="handleCellClick"
    ></data-table>

  </div>

  <!-- Edit user modal -->
  <edit-modal
    :show="showEditUserModal"
    title="Benutzer bearbeiten"
    :display-fields="editUserDisplayFields"
    :edit-fields="editUserEditFields"
    :success-message="editUserSuccess ? 'Bearbeitung erfolgreich' : ''"
    :error-message="editUserError"
    @close="closeEditUser"
    @submit="updateUser"
  ></edit-modal>
</div>

<%- include('partials/footer'); -%>

<script>
  const app = Vue.createApp({
    components: {
        DataTable,
        EditModal
    },
    data() {
      return {
        filter: JSON.parse('<%- filter %>'),
        users: JSON.parse('<%- JSON.stringify(users) %>'),
        error: "",
        searchLastName: "",
        showEditUserModal: false,
        editUserId: "",
        editUserEmail: "",
        editUserActive: false,
        editUserSuccess: false,
        editUserError: "",

        // Table configuration
        userColumns: [
          { key: 'id', label: 'User Id', visible: true },
          { key: 'firstName', label: 'Vorname', visible: true, filterable: true },
          { key: 'lastName', label: 'Nachname', visible: true, clickable: true, filterable: true },
          { key: 'email', label: 'Email', visible: true },
          { key: 'voice', label: 'Stimmgruppe', visible: true },
          { key: 'memberState', label: 'M-Status', visible: true }
        ]

      };
    },
    computed: {
      editUserDisplayFields() {
        return [
          { key: 'userId', label: 'User Id', value: this.editUserId }
        ];
      },
      editUserEditFields() {
        return [
          { key: 'email', label: 'E-Mail', value: this.editUserEmail, type: 'text' },
          { key: 'active', label: 'Aktiv', value: this.editUserActive, type: 'checkbox' }
        ];
      },
      filteredUsers() {
        if (!this.searchLastName) return this.users;
        const search = this.searchLastName.toUpperCase();
        return this.users.filter((user) =>
          user.lastName.toUpperCase().includes(search)
        );
      },
    },
    methods: {
      async handleFilterSubmit() {
        this.error = "";
        try {
          const res = await fetch("/admin/users-vue", {
            method: "POST",
            body: JSON.stringify({
              active: this.filter.active,
            }),
            headers: {
              "Content-Type": "application/json",
            },
          });
          const data = await res.json();

          if (data.errors) {
            this.error = data.errors;
          } else if (data.users) {
            this.users = data.users;
            this.searchLastName = "";
          }
        } catch (err) {
          this.error = err.message;
        }
      },
      handleCellClick({ row, column }) {
        if (column.key === 'lastName') {
            this.editUser(row);
        }
      },
      editUser(user) {
        this.editUserId = user.id;
        this.editUserEmail = user.email;
        this.editUserActive = user.active;
        this.editUserSuccess = false;
        this.editUserError = "";
        this.showEditUserModal = true;
      },
      closeEditUser() {
        this.showEditUserModal = false;
      },
      async updateUser(values) {
        // Update local state from component values
        this.editUserEmail = values.email;
        this.editUserActive = values.active;

        this.editUserError = "";
        this.editUserSuccess = false;

        try {
          const res = await fetch("/admin/updateUser", {
            method: "POST",
            body: JSON.stringify({
              id: this.editUserId,
              email: this.editUserEmail,
              active: this.editUserActive,
            }),
            headers: {
              "Content-Type": "application/json",
            },
          });
          const data = await res.json();

          if (data.errors) {
            this.editUserError = data.errors;
          } else if (data.updateUser) {
            this.editUserSuccess = true;
            // Update user in list
            const user = this.users.find((u) => u.id === this.editUserId);
            if (user) {
              user.email = this.editUserEmail;
              user.active = this.editUserActive;
            }
          }
        } catch (err) {
          this.editUserError = err.message;
        }
      },
    },
    mounted() {
      // Load users on initial page load
      this.handleFilterSubmit();
    },
  });

  app.mount("#app");
</script>
