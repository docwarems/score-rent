<%- include('partials/header'); -%>

<script src='https://unpkg.com/vue@3.0.2'></script>

<%- include('components/DataTable.vue.ejs'); %>

<h1>Ausleihen</h1>
  
<div id="app">
    <div v-show="error" class="w3-panel w3-red">
        <p>{{ error }}</p>
    </div>
    
    <div v-if="admin" class="w3-panel w3-border">
        <form @submit.prevent="handleCheckoutsFilterSubmit">
            <h3>Filter</h3>
            <label>Noten Signatur</label>
        
            <select class="w3-select" v-model="signature">                
                <option value="">Noten ausw채hlen</option>
                <option v-for="signature in signatures" :value="signature.id">{{signature.name}}</option>
            </select>
        
            <label>Nur offene&nbsp;</label>
            <input type="checkbox" class="w3-check" v-model="checkedOut">
            <p></p>
            <button class="w3-button w3-black">Suchen</button>
            <p></p>
        </form>
    </div>

    <div v-if="checkouts">
        <div class="w3-left-align"><p>{{ statSummary }}</p></div>
        <data-table
            :columns="checkoutColumns"
            :rows="checkouts"
            row-key="id"
            @cell-click="handleCellClick"
        ></data-table>
    </div>


    <!-- The user details modal -->
    <div
        class="w3-modal"
        :style="{ display: showUserDetailsModal ? 'block' : 'none' }"
    >
        <div class="w3-modal-content">
        <div class="w3-container">
            <span @click="closeUserDetails" class="w3-button w3-display-topright">&times;</span>
            <p>{{ userDetailsName }}</p>
            <table class="w3-table-all" id="checkoutsTable">
            <tr>
                <th>E-Mail</th>
                <th>Registriert am</th>
            </tr>
            <tr>
                <td class="userDetailsEmail">{{ userDetailsEmail }}</td>
                <td class="userDetailsRegisterDate">{{userDetailsRegisterDate }}</td>
            </tr>
            </table>
            <p></p>    
        </div>
        </div>
    </div>  

    <!-- edit checkout modal -->
    <div
        class="w3-modal"
        :style="{ display: showEditCheckoutModal ? 'block' : 'none' }"
    >
        <div class="w3-modal-content">
        <div class="w3-container">
            <span @click="closeEditCheckout" class="w3-button w3-display-topright">&times;</span>
            <h3>Ausleihe bearbeiten</h3>
    
            <div v-show="showEditCheckoutModalSuccess" class="w3-panel w3-green">
            <p>Bearbeitung erfolgreich:</p>
            </div>
            <div v-show="editCheckoutModalError" class="w3-panel w3-red">
            <p>{{ editCheckoutModalError }}</p>
            </div>
    
            <p>{{ editCheckoutScoreId }}</p>
            <p>{{ editCheckoutId }}</p>
    
            <form @submit.prevent="updateCheckout">
            <input type="hidden" v-model="editCheckoutScoreId">
            <input type="hidden" v-model="editCheckoutId">
            <table class="w3-table-all">
                <tr>
                <th>Kommentar Ausleihe</th>
                <th>Kommentar R체ckgabe</th>
                <th>User Id</th>
                </tr>
                <tr>
                <td><input v-model="editCheckoutComment" class="w3-input"></td>
                <td><input v-model="editCheckinComment" class="w3-input"></td>
                <td><input v-model="editCheckoutUserId" class="w3-input"></td>
                </tr>
            </table>
            <p></p>
            <button class="w3-button w3-black">OK</button>
            </form>
    
            <P></P>
            <h4>User suchen</h4>
    
            <form @click.prevent="userSearch">
            <table class="w3-table-all">
                <tr>
                <th>Nachname</th>
                </tr>
                <tr>
                <td><input class="w3-input" v-model="userLastName"></td>
                </tr>
            </table>
            <p></p>
            <button class="w3-button w3-black">User suchen</button>
            </form>
            <p></p>
            <table class="w3-table-all tableUsers">
                <tr v-for="user in users" :key="user.id">
                    <td>
                        <button @click="chooseUser(user.id)" class="w3-button w3-pale-blue">
                            {{ user.firstName }} {{ user.lastName }}
                        </button>
                    </td>
                </tr>
            </table>   
            <p></p>
    
        </div>
        </div>
    </div>
  

</div>

<%- include('partials/footer'); -%>

<script>

const app = Vue.createApp({
    components: {
        DataTable
    },
    data() {
        return {
            admin: JSON.parse('<%- admin %>'),
            signature: "",
            signatures: JSON.parse('<%- signatures %>'),
            filter: JSON.parse('<%- filter %>'),
            checkouts: undefined,
            checkedOut: true,
            scoreTypeTotalCount: 0,
            scoreTypeTotalCheckedOutCount: 0,
            statSummary: '',
            error: '',
            SIGNATURE_ALL: { id: 'ALL', name: 'Alle'},
            userNamePlusVoice: '',
            showUserDetailsModal: false,
            userDetailsName: '',
            userDetailsEmail: '',
            userDetailsRegisterDate: 'TODO',
            editCheckoutId: '',
            editCheckoutScoreId: '',
            editCheckoutComment: '',
            editCheckinComment: '',
            editCheckoutUserId: '',
            showEditCheckoutModal: false,
            showEditCheckoutModalSuccess: false,
            showFoo: false,
            editCheckoutModalError: '',
            users: [],
            userLastName: '',
        }
    },
    computed: {
        checkoutColumns() {
            return [
                { 
                    key: 'signature', 
                    label: 'Werk', 
                    visible: this.filter.signature === this.SIGNATURE_ALL.id,
                    formatter: (val, row) => row.signature // Add signatureMap lookup if needed
                },
                { key: 'scoreId', label: 'Noten Id' },
                { key: 'scoreExtId', label: 'Noten ext. Id', filterable: true },
                { 
                    key: 'userName', 
                    label: 'Benutzer', 
                    visible: this.admin,
                    clickable: true,
                    filterable: true,
                    formatter: (val, row) => row.user.namePlusVoice
                },
                { 
                    key: 'checkoutTimestamp', 
                    label: 'Ausgeliehen am',
                    clickable: this.admin
                },
                { key: 'checkoutComment', label: 'Kommentar Ausleihe' },
                { key: 'checkinTimestamp', label: 'R체ckgabe am' },
                { key: 'checkinComment', label: 'Kommentar R체ckgabe' }
            ];
        }
    },
    methods: {
        handleCellClick({ row, column }) {
            if (column.key === 'userName') {
                this.userDetails(row.user);
            } else if (column.key === 'checkoutTimestamp') {
                this.editCheckout(row);
            }
        },
        userDetails(user) {
            this.userDetailsName = user.name;
            this.userDetailsEmail = user.email;
            this.showUserDetailsModal = true;
        },
        closeUserDetails() {
            this.showUserDetailsModal = false;
        },
        editCheckout(checkout) {
            this.showEditCheckoutModalSuccess = false;
            this.editCheckoutId = checkout.id;
            this.editCheckoutScoreId = checkout.scoreId;
            this.editCheckoutComment = checkout.checkoutComment;
            this.editCheckinComment = checkout.checkinComment;
            this.editCheckoutUserId = checkout.user.id;
            this.showEditCheckoutModal = true;
        },
        async updateCheckout() {
            console.log("editCheckoutComment", this.editCheckoutComment, "editCheckinComment=", this.editCheckinComment, "editCheckoutUserId=", this.editCheckoutUserId);

            const res = await fetch('/admin/updateCheckout', {
                method: 'POST',
                body: JSON.stringify({
                    scoreId: this.editCheckoutScoreId,
                    checkoutId: this.editCheckoutId,
                    checkoutComment: this.editCheckoutComment,
                    checkinComment: this.editCheckinComment,
                    userId: this.editCheckoutUserId,
                }),
                    headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await res.json();
            console.log("data=", data);

            if (data.errors) {
                this.editCheckoutModalError = data.errors;
            }
            if (data.updateScore) {
                this.showEditCheckoutModalSuccess = true;
                // TODO: update filtered checkouts list
            }
        },
        closeEditCheckout() {
            this.showEditCheckoutModal = false;
        },
        async handleCheckoutsFilterSubmit() {
            this.error = "";
            try {
                const res = await fetch('/admin/checkouts-vue', {
                    method: 'POST',
                    body: JSON.stringify({
                        signature: this.signature,
                        checkedOut: this.checkedOut,
                        userId: undefined,
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await res.json();
                // console.log("data=", data);
                if (data.error) {
                    this.error = data.error;
                    return;
                }
                this.admin = data.admin;
                this.checkouts = data.checkouts;
            } catch (err) {
                console.log("err=", err);
                this.error = err.message;
            }
        },
        async userSearch() {
            try {
                const res = await fetch('/admin/userSearch', {
                        method: 'POST',
                        body: JSON.stringify({
                        lastName: this.userLastName,
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await res.json();
                console.log("data=", data);
                if (data.errors) {
                    this.editCheckoutModalError = data.errors;
                    return;
                }
                if (data.users) {
                    this.users = data.users;
                }
            } catch (err) {
                console.log("err=", err);
                this.editCheckoutModalError = err.message;
            }
        },
        chooseUser(userId) {
            this.editCheckoutUserId = userId;
        }
    },
})

app.mount('#app')    
</script>



