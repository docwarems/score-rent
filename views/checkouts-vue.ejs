<%- include('partials/header'); -%>

<script src='https://unpkg.com/vue@3.0.2'></script>

<%- include('components/DataTable.vue.ejs'); %>
<%- include('components/EditModal.vue.ejs'); %>

<h1>Ausleihen</h1>
  
<div id="app">
    <div v-show="error" class="w3-panel w3-red">
        <p>{{ error }}</p>
    </div>
    
    <div v-if="admin" class="w3-panel w3-border">
        <form @submit.prevent="handleCheckoutsFilterSubmit">
            <h3>Filter</h3>
            <label>Noten Signatur</label>
            <select class="w3-select" v-model="signature">                
                <option value="">Noten ausw채hlen</option>
                <option v-for="signature in signatures" :value="signature.id">{{signature.name}}</option>
            </select>
            <label>Nur offene&nbsp;</label>
            <input type="checkbox" class="w3-check" v-model="checkedOut">
            &nbsp;
            <label>Mit Ausleihzettel&nbsp;</label>
            <input type="checkbox" class="w3-check" v-model="withCheckoutSheet">
            <p></p>
            <button class="w3-button w3-black">Suchen</button>
            <p></p>
        </form>
    </div>

    <div v-if="checkouts">
        <div class="w3-left-align"><p>{{ statSummary }}</p></div>
        <data-table
            :columns="checkoutColumns"
            :rows="checkouts"
            row-key="id"
            @cell-click="handleCellClick"
        ></data-table>
    </div>


    <!-- The user details modal -->
    <div
        class="w3-modal"
        :style="{ display: showUserDetailsModal ? 'block' : 'none' }"
    >
        <div class="w3-modal-content">
        <div class="w3-container">
            <span @click="closeUserDetails" class="w3-button w3-display-topright">&times;</span>
            <p>{{ userDetailsName }}</p>
            <table class="w3-table-all" id="checkoutsTable">
            <tr>
                <th>E-Mail</th>
                <th>Registriert am</th>
            </tr>
            <tr>
                <td class="userDetailsEmail">{{ userDetailsEmail }}</td>
                <td class="userDetailsRegisterDate">{{userDetailsRegisterDate }}</td>
            </tr>
            </table>
            <p></p>    
        </div>
        </div>
    </div>  

    <!-- foto modal -->
    <div class="w3-modal" :style="{ display: showFotoDialog ? 'block' : 'none' }">
        <div class="w3-modal-content w3-center">
            <div class="w3-container">
                <span @click="closeFotoDialog" class="w3-button w3-display-topright">&times;</span>
                <h3>Foto aufnehmen</h3>
                <div v-if="storedPhotoBase64 && !capturedPhoto">
                    <div style="margin-bottom:10px;">
                        <span style="font-size:0.9em;color:#888;">Gespeichertes Foto:</span><br>
                        <img :src="storedPhotoBase64" style="margin-top:4px;max-width:100%;border:1px solid #ccc;" />
                    </div>
                </div>
                <video ref="fotoVideo" autoplay playsinline width="320" height="240" style="border:1px solid #ccc;"></video>

                <br>
                <button class="w3-button w3-green" @click="capturePhoto">Foto aufnehmen</button>
                <br>
                <canvas ref="fotoCanvas" width="320" height="240" style="display:none;"></canvas>
                <div v-if="capturedPhoto">
                    <img :src="capturedPhoto" style="margin-top:10px;max-width:100%;height:auto;border:1px solid #ccc;" />
                    <br>
                    <button class="w3-button w3-black" @click="saveFoto" :disabled="fotoUploadStatus==='saving'">Speichern</button>
                    <div v-if="fotoUploadStatus && fotoUploadStatus!=='saving'" style="margin-top:8px;">
                        <span v-if="fotoUploadStatus==='success'" style="color:green;">Foto gespeichert!</span>
                        <span v-else style="color:red;">{{ fotoUploadStatus }}</span>
                    </div>
                </div>            
            </div>
        </div>
    </div>

    <!-- edit checkout modal -->
    <edit-modal
        :show="showEditCheckoutModal"
        title="Ausleihe bearbeiten"
        :display-fields="editCheckoutDisplayFields"
        :edit-fields="editCheckoutEditFields"
        :success-message="showEditCheckoutModalSuccess ? 'Bearbeitung erfolgreich' : ''"
        :error-message="editCheckoutModalError"
        :show-user-search="true"
        :users="users"
        v-model:user-search-value="userLastName"
        @close="closeEditCheckout"
        @submit="updateCheckout"
        @user-search="userSearch"
        @choose-user="chooseUser"
    ></edit-modal>
  

</div>

<%- include('partials/footer'); -%>

<script>

const app = Vue.createApp({
    components: {
        DataTable,
        EditModal
    },
    data() {
        return {
            admin: JSON.parse('<%- admin %>'),
            signature: "",
            signatures: JSON.parse('<%- signatures %>'),
            filter: JSON.parse('<%- filter %>'),
            checkouts: undefined,
            checkedOut: true,
            withCheckoutSheet: false,
            scoreTypeTotalCount: 0,
            scoreTypeTotalCheckedOutCount: 0,
            statSummary: '',
            error: '',
            SIGNATURE_ALL: { id: 'ALL', name: 'Alle'},
            userNamePlusVoice: '',
            showUserDetailsModal: false,
            userDetailsName: '',
            userDetailsEmail: '',
            userDetailsRegisterDate: 'TODO',
            editCheckoutId: '',
            editCheckoutScoreId: '',
            editCheckoutComment: '',
            editCheckinComment: '',
            editCheckoutUserId: '',
            showEditCheckoutModal: false,
            showEditCheckoutModalSuccess: false,
            showFoo: false,
            editCheckoutModalError: '',
            users: [],
            userLastName: '',
            showFotoDialog: false,
            fotoDialogRow: null,
            cameraStream: null,
            capturedPhoto: '',
            fotoUploadStatus: '',
            storedPhotoBase64: '',
        }
    },
    computed: {
        checkoutColumns() {
            const columns = [
                { 
                    key: 'signature', 
                    label: 'Werk', 
                    visible: this.filter.signature === this.SIGNATURE_ALL.id,
                    formatter: (val, row) => row.signature // Add signatureMap lookup if needed
                },
                { key: 'scoreId', label: 'Noten Id' },
                { key: 'scoreExtId', label: 'Noten ext. Id', filterable: true },
                { 
                    key: 'userName', 
                    label: 'Benutzer', 
                    visible: this.admin,
                    clickable: true,
                    filterable: true,
                    formatter: (val, row) => row.user.namePlusVoice
                },
                { 
                    key: 'checkoutTimestamp', 
                    label: 'Ausgeliehen am',
                    clickable: this.admin
                },
                { key: 'checkoutComment', label: 'Kommentar Ausleihe' },
                { key: 'checkinTimestamp', label: 'R체ckgabe am' },
                { key: 'checkinComment', label: 'Kommentar R체ckgabe' }
            ];
            if (this.withCheckoutSheet) {
                columns.unshift({ key: 'id', label: 'Ausleihzettel Id' });
                columns.push({ 
                    key: 'fotoAction', 
                    label: 'Foto', 
                    clickable: true, 
                    visible: true,
                    formatter: () => 'Foto'
                });                
            }
            return columns;
        },
        editCheckoutDisplayFields() {
            return [
                { key: 'scoreId', value: this.editCheckoutScoreId },
                { key: 'checkoutId', value: this.editCheckoutId }
            ];
        },
        editCheckoutEditFields() {
            return [
                { key: 'checkoutComment', label: 'Kommentar Ausleihe', value: this.editCheckoutComment },
                { key: 'checkinComment', label: 'Kommentar R체ckgabe', value: this.editCheckinComment },
                { key: 'userId', label: 'User Id', value: this.editCheckoutUserId }
            ];
        }
    },
    methods: {
        handleCellClick({ row, column }) {
            if (column.key === 'userName') {
                this.userDetails(row.user);
            } else if (column.key === 'checkoutTimestamp') {
                this.editCheckout(row);
            } else if (column.key === 'fotoAction') {
                this.openFotoDialog(row);
            }            
        },
        userDetails(user) {
            this.userDetailsName = user.name;
            this.userDetailsEmail = user.email;
            this.showUserDetailsModal = true;
        },
        closeUserDetails() {
            this.showUserDetailsModal = false;
        },
        editCheckout(checkout) {
            this.showEditCheckoutModalSuccess = false;
            this.editCheckoutId = checkout.id;
            this.editCheckoutScoreId = checkout.scoreId;
            this.editCheckoutComment = checkout.checkoutComment;
            this.editCheckinComment = checkout.checkinComment;
            this.editCheckoutUserId = checkout.user.id;
            this.showEditCheckoutModal = true;
        },
        async updateCheckout(values) {
            // Update local state from component values
            this.editCheckoutComment = values.checkoutComment;
            this.editCheckinComment = values.checkinComment;
            this.editCheckoutUserId = values.userId;

            // console.log("editCheckoutComment", this.editCheckoutComment, "editCheckinComment=", this.editCheckinComment, "editCheckoutUserId=", this.editCheckoutUserId);

            const res = await fetch('/admin/updateCheckout', {
                method: 'POST',
                body: JSON.stringify({
                    scoreId: this.editCheckoutScoreId,
                    checkoutId: this.editCheckoutId,
                    checkoutComment: this.editCheckoutComment,
                    checkinComment: this.editCheckinComment,
                    userId: this.editCheckoutUserId,
                }),
                    headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await res.json();
            // console.log("data=", data);

            if (data.errors) {
                this.editCheckoutModalError = data.errors;
            }
            if (data.updateScore) {
                this.showEditCheckoutModalSuccess = true;
                // TODO: update filtered checkouts list
            }
        },
        closeEditCheckout() {
            this.showEditCheckoutModal = false;
        },
        async handleCheckoutsFilterSubmit() {
            this.error = "";
            try {
                const res = await fetch('/admin/checkouts-vue', {
                    method: 'POST',
                    body: JSON.stringify({
                        signature: this.signature,
                        checkedOut: this.checkedOut,
                        withCheckoutSheet: this.withCheckoutSheet,
                        userId: undefined,
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await res.json();
                // console.log("data=", data);
                if (data.error) {
                    this.error = data.error;
                    return;
                }
                this.admin = data.admin;
                this.checkouts = data.checkouts;
            } catch (err) {
                console.log("err=", err);
                this.error = err.message;
            }
        },
        async userSearch() {
            try {
                const res = await fetch('/admin/userSearch', {
                        method: 'POST',
                        body: JSON.stringify({
                        lastName: this.userLastName,
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await res.json();
                console.log("data=", data);
                if (data.errors) {
                    this.editCheckoutModalError = data.errors;
                    return;
                }
                if (data.users) {
                    this.users = data.users;
                }
            } catch (err) {
                console.log("err=", err);
                this.editCheckoutModalError = err.message;
            }
        },
        chooseUser(userId) {
            this.editCheckoutUserId = userId;
        },
        async openFotoDialog(row) {
            this.showFotoDialog = true;
            this.fotoDialogRow = row;
            this.capturedPhoto = '';
            this.fotoUploadStatus = '';
            this.storedPhotoBase64 = '';
            // Fetch stored photo
            try {
                const res = await fetch(`/admin/getCheckoutPhoto?checkoutId=${encodeURIComponent(row.id)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.photoBase64) {
                        this.storedPhotoBase64 = data.photoBase64;
                    }
                }
            } catch (err) {
                // Ignore fetch errors for now
            }
            this.startCamera();
        },
        async startCamera() {
            try {
                let stream = null;
                const constraints = {
                    video: {
                        facingMode: { exact: "environment" },
                        aspectRatio: { ideal: 4/3 },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                try {
                    // Try to use the environment (rear) camera with landscape aspect
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (e) {
                    // Fallback to any available camera
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                }
                this.cameraStream = stream;
                this.$nextTick(() => {
                    if (this.$refs.fotoVideo) {
                        this.$refs.fotoVideo.srcObject = stream;
                    }
                });
            } catch (err) {
                this.error = 'Kamera konnte nicht gestartet werden: ' + err.message;
            }
        },
        stopCamera() {
            if (this.cameraStream) {
                this.cameraStream.getTracks().forEach(track => track.stop());
                this.cameraStream = null;
            }
        },
        closeFotoDialog() {
            this.showFotoDialog = false;
            this.stopCamera();
            this.capturedPhoto = '';
            this.storedPhotoBase64 = '';
            this.fotoUploadStatus = '';
        },        
        capturePhoto() {
            const video = this.$refs.fotoVideo;
            const canvas = this.$refs.fotoCanvas;
            if (video && canvas) {
                // Set canvas size to video size for correct aspect ratio
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                this.capturedPhoto = canvas.toDataURL('image/png');
            }
        },
        async saveFoto() {
            if (!this.capturedPhoto || !this.fotoDialogRow) return;
            this.fotoUploadStatus = 'saving';
            try {
                const res = await fetch('/admin/uploadCheckoutPhoto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        checkoutId: this.fotoDialogRow.id,
                        imageBase64: this.capturedPhoto
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.fotoUploadStatus = 'success';
                } else {
                    this.fotoUploadStatus = data.error || 'Fehler beim Speichern.';
                }
            } catch (err) {
                this.fotoUploadStatus = err.message || 'Fehler beim Speichern.';
            }
        },
    },
})

app.mount('#app')    
</script>



